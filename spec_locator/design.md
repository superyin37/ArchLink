# CAD 截图规范定位服务

## 开发设计文档（Spec Locator Service）

**作者**：殷 晗陽
**模块名称**：Spec Locator Service
**版本**：v1.0
**状态**：设计定稿 / 开发中

---

## 1. 背景与目标

在建筑设计辅助软件中，需要支持一种“以图搜图”的核心能力：
用户上传一张包含规范引用的 CAD 截图，系统自动识别其中对应的**建筑规范编号**与**页码**，并据此从规范资料库中定位并返回对应的 PDF 文件。

CAD 图纸中的规范引用具有如下工程特性：

* 文本元素位置分散，排列无固定顺序
* 规范编号与页码常被拆分为多个独立标注
* 存在大量结构线、引线、圆圈等非文本干扰
* 页码通常依赖空间关系而非连续字符串出现

因此，本功能需要以**结构化信息抽取**为目标，构建一个独立、稳定、可复用的识别服务。

---

## 2. 模块职责与系统边界

### 2.1 本模块的职责范围

Spec Locator Service 的职责被严格限定为：

* 接收一张 CAD 截图（图片文件）
* 从图像中识别并解析：
  * 建筑规范编号（如 `12J2`）
  * 对应页码（如 `C11-2`）
* **索引与查找PDF文件**（v1.1新增）
  * 自动索引 output_pages 目录中的PDF文件
  * 根据识别结果智能匹配对应的PDF文件
  * 提供文件下载服务
* 输出结构化识别结果及置信信息

### 2.2 明确不属于本模块的职责

以下内容不由本模块承担：

* 规范 PDF 的原始存储与管理（仅索引现有文件）
* 前端上传逻辑与 UI 交互
* 权限控制、鉴权、日志审计
* 业务规则判断（例如规范是否可访问）

本模块仅作为**能力型服务**存在，对外提供稳定 API。

---

## 3. 系统整体对接位置

### 3.1 系统交互关系

```
前端 / 上游系统
   |
   |  上传 CAD 截图
   ↓
主系统后端
   |
   |  HTTP API 调用
   ↓
Spec Locator Service
   |
   |  ├─ JSON（规范编号 + 页码 + PDF文件信息）
   |  └─ 或直接下载PDF文件
   ↓
主系统后端 / 用户
```

### 3.2 对接原则

* 单向依赖：主系统依赖本服务，本服务不依赖主系统
* 接口稳定：通过固定协议进行通信
* 实现透明：主系统不感知 OCR 与解析细节

---

## 4. 内部模块划分与职责

本服务内部采用模块化设计，以保证可维护性与可扩展性。

### 4.1 目录结构示意

```
spec_locator/
├── api/
│   └── server.py            # HTTP API 层（识别+下载）
├── preprocess/
│   └── image_preprocess.py  # 图像预处理（去线、增强）
├── ocr/
│   └── ocr_engine.py        # OCR 引擎封装（带 bbox）
├── parser/
│   ├── spec_code.py         # 规范编号解析
│   ├── page_code.py         # 页码结构化解析
│   └── geometry.py          # 空间关系与距离计算
├── postprocess/
│   └── confidence.py        # 置信度评估与候选排序
├── database/                 # 文件索引（新增）
│   └── file_index.py        # PDF文件索引与查找
├── core/
│   └── pipeline.py          # 主处理流水线 + 文件查找
├── tests/
├── config/
└── README.md
```

---

### 4.2 各模块职责说明

#### 4.2.1 API 层（api）

* 提供 HTTP 接口
* 处理文件上传与参数校验
* 调用内部识别流水线
* 统一封装返回结果与错误码

---

#### 4.2.2 图像预处理模块（preprocess）

* 灰度化、二值化
* 去除 CAD 结构线与标注线
* 提升文字区域对比度

该模块目标是最大化 OCR 识别稳定性。

---

#### 4.2.3 OCR 模块（ocr）

* 封装 OCR 引擎
* 输出带有位置信息（bounding box）的文本结果
* 不做任何语义判断

OCR 输出为后续结构化解析提供基础数据。

---

#### 4.2.4 解析模块（parser）

**spec_code.py**

* 从 OCR 文本中识别规范编号
* 基于正则规则与字符修正

**page_code.py**

* 识别页码的组成部分（如 `C11`、`2`）
* 结合空间关系进行页码组合

**geometry.py**

* 提供文本框之间的距离、方向、邻近关系计算
* 支持“右侧 / 下方 / 最近”等判定规则

---

#### 4.2.5 后处理模块（postprocess）

* 汇总多个候选结果
* 计算整体置信度
* 对候选结果进行排序

---

#### 4.2.6 核心流水线（core）

* 串联所有子模块
* 控制整体识别流程
* 对异常情况进行统一处理

---

## 5. 对外 API 设计

### 5.1 API 基本信息

* 协议：HTTP / HTTPS
* 风格：REST
* 数据格式：JSON
* 文件传输：multipart/form-data

---

### 5.2 接口定义

#### Endpoint

```
POST /api/spec-locate
```

---

#### Request

**Content-Type**

```
multipart/form-data
```

**参数**

| 字段   | 类型   | 必填 | 说明                |
| ---- | ---- | -- | ----------------- |
| file | File | 是  | CAD 截图（png / jpg） |

---

#### Response（成功）

```json
{
  "success": true,
  "spec": {
    "code": "12J2",
    "page": "C11-2",
    "confidence": 0.93
  },
  "candidates": [
    {
      "code": "12J2",
      "page": "C11-2",
      "confidence": 0.93
    },
    {
      "code": "12J2",
      "page": "C11-1",
      "confidence": 0.41
    }
  ]
}
```

---

#### Response（失败）

```json
{
  "success": false,
  "error_code": "NO_MATCH",
  "message": "Failed to identify spec code or page from image."
}
```

---

### 5.3 错误码定义

| error_code     | 含义       |
| -------------- | -------- |
| NO_TEXT        | 未识别到有效文本 |
| NO_SPEC_CODE   | 未识别到规范编号 |
| NO_PAGE_CODE   | 未识别到页码   |
| NO_MATCH       | 无法组合有效结果 |
| INTERNAL_ERROR | 内部错误     |

---

## 6. 内部处理流程说明

```
图像输入
  ↓
图像预处理
  ↓
OCR（文本 + bbox）
  ↓
规范编号识别
  ↓
页码空间组合
  ↓
候选生成与置信度评估
  ↓
结果输出
```

---

## 7. 返回结果使用约定（主系统侧）

主系统根据返回结果拼接 PDF 名称：

```
<规范编号>_<页码>.pdf
```

示例：

```
12J2_C11-2.pdf
```

PDF 的存在性校验与返回逻辑由主系统负责。

---

## 8. 性能与部署预期

* 单张图片处理耗时：数百毫秒级
* 服务为无状态设计，可横向扩展
* 支持本地部署与容器化部署

---

## 9. 版本演进规划

* v1.1：支持多规范同时识别
* v1.2：增加调试模式（返回 OCR 可视化）
* v2.0：引入模型判断页码区域

---

## 10. 总结

Spec Locator Service 被设计为一个：

* 职责单一
* 接口清晰
* 可独立部署
* 可持续演进

的规范定位识别服务。

通过明确的模块划分与对外 API 约定，该服务可以在不侵入业务逻辑的前提下，为整体系统提供稳定、可维护的“以图搜图”能力。
